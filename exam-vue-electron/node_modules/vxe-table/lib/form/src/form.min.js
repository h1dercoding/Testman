"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=require("../../tools/utils"),_dom=_interopRequireWildcard(require("../../tools/dom")),_util=require("./util"),_render=require("./render"),_log=require("../../tools/log");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(_getRequireWildcardCache=function(e){return e?i:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var i,l,r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&((l=n?Object.getOwnPropertyDescriptor(e,i):null)&&(l.get||l.set)?Object.defineProperty(r,i,l):r[i]=e[i]);return r.default=e,t&&t.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var l=t[i];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"content",get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}]),t}();function validErrorRuleValue(e,t){var i=e.type,l=e.min,r=e.max,n=e.pattern,e="number"===i,i=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||(!_xeUtils.default.eqNull(l)&&i<_xeUtils.default.toNumber(l)||(!_xeUtils.default.eqNull(r)&&i>_xeUtils.default.toNumber(r)||!(!n||(_xeUtils.default.isRegExp(n)?n:new RegExp(n)).test(t))))}function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}function renderItems(R,$,e){var O=$._e,w=$.rules,I=$.data,S=$.collapseAll,U=$.validOpts,q=$.titleOverflow;return e.map(function(e){var t,i=e.slots,l=e.title,r=e.folding,n=e.visible,o=e.visibleMethod,s=e.field,a=e.collapseNode,u=e.itemRender,c=e.showError,f=e.errRule,d=e.className,m=e.titleOverflow,p=e.children,h=(0,_utils.isEnableConf)(u)?_vXETable.default.renderer.get(u.name):null,v=e.span||$.span,g=e.align||$.align,_=e.titleAlign||$.titleAlign,x=e.titleWidth||$.titleWidth,y=o,b=_xeUtils.default.isUndefined(m)||_xeUtils.default.isNull(m)?q:m,o="title"===b,m=!0===b||"tooltip"===b,b=o||m||"ellipsis"===b,E={data:I,field:s,property:s,item:e,$form:$};if(!1===n)return O();if(p&&0<p.length){p=renderItems(R,$,e.children);return p.length?R("div",{class:["vxe-form--gather vxe-row",e.id,v?"vxe-col--".concat(v," is--span"):"",d?_xeUtils.default.isFunction(d)?d(E):d:""]},p):O()}!y&&h&&h.itemVisibleMethod&&(y=h.itemVisibleMethod),!w||(T=w[s])&&(t=T.some(function(e){return e.required}));var T=[];i&&i.default?T=$.callSlot(i.default,E,R):h&&h.renderItemContent?T=h.renderItemContent.call($,R,u,E):h&&h.renderItem?T=h.renderItem.call($,R,u,E):s&&(T=["".concat(_xeUtils.default.get(I,s))]);m=m?{mouseenter:function(e){$.triggerTitleTipEvent(e,E)},mouseleave:$.handleTitleTipLeaveEvent}:{};return R("div",{class:["vxe-form--item",e.id,v?"vxe-col--".concat(v," is--span"):null,d?_xeUtils.default.isFunction(d)?d(E):d:"",{"is--title":l,"is--required":t,"is--hidden":r&&S,"is--active":!y||y(E),"is--error":c}],key:e.id},[R("div",{class:"vxe-form--item-inner"},[l||i&&i.title?R("div",{class:["vxe-form--item-title",_?"align--".concat(_):null,{"is--ellipsis":b}],style:x?{width:isNaN(x)?x:"".concat(x,"px")}:null,attrs:{title:o?(0,_utils.getFuncText)(l):null},on:m},(0,_render.renderTitle)(R,$,e)):null,R("div",{class:["vxe-form--item-content",g?"align--".concat(g):null]},T.concat([a?R("div",{class:"vxe-form--item-trigger-node",on:{click:$.toggleCollapseEvent}},[R("span",{class:"vxe-form--item-trigger-text"},S?_conf.default.i18n("vxe.form.unfolding"):_conf.default.i18n("vxe.form.folding")),R("i",{class:["vxe-form--item-trigger-icon",S?_conf.default.icon.FORM_FOLDING:_conf.default.icon.FORM_UNFOLDING]})]):null,f&&U.showMessage?R("div",{class:"vxe-form--item-valid",style:f.maxWidth?{width:"".concat(f.maxWidth,"px")}:null},f.content):null]))])])})}var _default2={name:"VxeForm",mixins:[_size.default],props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:{type:[String,Number],default:function(){return _conf.default.form.span}},align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return _conf.default.form.titleWidth}},titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},data:function(){return{collapseAll:this.collapseStatus,staticItems:[],formItems:[],tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}},provide:function(){return{$xeform:this}},computed:{validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)},tooltipOpts:function(){return Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,this.tooltipConfig)}},watch:{staticItems:function(e){this.formItems=e},items:function(e){this.loadItem(e)},collapseStatus:function(e){this.collapseAll=!!e}},created:function(){var t=this;this.$nextTick(function(){var e=t.items;"development"===process.env.NODE_ENV&&t.customLayout&&t.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"]),e&&t.loadItem(e)})},render:function(e){var t=this._e,i=this.loading,l=this.className,r=this.data,n=this.vSize,o=this.tooltipOpts,s=this.formItems,a=this.customLayout,u=_vXETable.default._tooltip;return e("form",{class:["vxe-form",l?_xeUtils.default.isFunction(l)?l({items:s,data:r,$form:this}):l:"",(_defineProperty(l={},"size--".concat(n),n),_defineProperty(l,"is--colon",this.titleColon),_defineProperty(l,"is--asterisk",this.titleAsterisk),_defineProperty(l,"is--loading",i),l)],on:{submit:this.submitEvent,reset:this.resetEvent}},[e("div",{class:"vxe-form--wrapper vxe-row"},a?this.$slots.default:renderItems(e,this,s)),e("div",{class:"vxe-form-slots",ref:"hideItem"},a?[]:this.$slots.default),e("div",{class:["vxe-loading",{"is--visible":i}]},[e("div",{class:"vxe-loading--spinner"})]),u?e("vxe-tooltip",{ref:"tooltip",props:o}):t()])},methods:{callSlot:function(e,t,i){if(e){var l=this.$scopedSlots;if(_xeUtils.default.isString(e)&&(e=l[e]||null),_xeUtils.default.isFunction(e))return e.call(this,t,i)}return[]},loadItem:function(e){var t,i=this;return"development"===process.env.NODE_ENV&&(t=this.$scopedSlots,e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||t[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})})),this.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(i,e)},{children:"children"}),this.$nextTick()},getItems:function(){var t=[];return _xeUtils.default.eachTree(this.formItems,function(e){t.push(e)},{children:"children"}),t},getItemByField:function(t){var e=_xeUtils.default.findTree(this.formItems,function(e){return e.field===t},{children:"children"});return e?e.item:null},toggleCollapse:function(){var e=!this.collapseAll;return this.collapseAll=e,this.$emit("update:collapseStatus",e),this.$nextTick()},toggleCollapseEvent:function(e){this.toggleCollapse();var t=this.collapseAll;this.$emit("toggle-collapse",{status:t,collapse:t,data:this.data,$form:this,$event:e},e),this.$emit("collapse",{status:t,collapse:t,data:this.data,$form:this,$event:e},e)},submitEvent:function(t){var i=this;t.preventDefault(),this.preventSubmit||(this.clearValidate(),this.beginValidate(this.getItems()).then(function(){i.$emit("submit",{data:i.data,$form:i,$event:t})}).catch(function(e){i.$emit("submit-invalid",{data:i.data,errMap:e,$form:i,$event:t})}))},reset:function(){var r=this,n=this.data;return n&&this.getItems().forEach(function(e){var t=e.field,i=e.resetValue,l=e.itemRender;(0,_utils.isEnableConf)(l)&&((l=_vXETable.default.renderer.get(l.name))&&l.itemResetMethod?l.itemResetMethod({data:n,field:t,property:t,item:e,$form:r}):t&&_xeUtils.default.set(n,t,null===i?getResetValue(_xeUtils.default.get(n,t),void 0):i))}),this.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.$emit("reset",{data:this.data,$form:this,$event:e})},closeTooltip:function(){var e=this.tooltipStore,t=this.$refs.tooltip;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),this.$nextTick()},triggerTitleTipEvent:function(e,t){var i=t.item,l=this.tooltipStore,r=this.$refs.tooltip,n=e.currentTarget.children[0],t=(n.textContent||"").trim(),e=n.scrollWidth>n.clientWidth;clearTimeout(this.tooltipTimeout),l.item!==i&&this.closeTooltip(),t&&e&&(Object.assign(l,{item:i,visible:!0}),r&&r.open(n,t))},handleTitleTipLeaveEvent:function(){var e=this,t=this.tooltipOpts,i=this.$refs.tooltip;i&&i.setActived(!1),t.enterable?this.tooltipTimeout=setTimeout(function(){(i=e.$refs.tooltip)&&!i.isActived()&&e.closeTooltip()},t.leaveDelay):this.closeTooltip()},clearValidate:function(e){return e?(e=(0,_util.handleFieldOrItem)(this,e))&&(e.showError=!1):this.getItems().forEach(function(e){e.showError=!1}),this.$nextTick()},validate:function(e){return this.clearValidate(),this.beginValidate(this.getItems(),"",e)},validateField:function(e,t){e=(0,_util.handleFieldOrItem)(this,e);return this.beginValidate(e?[e]:[],"",t)},beginValidate:function(t,e,i){var r=this,n=this.data,l=this.rules,o=this.validOpts,s={},a=[],u=[];return clearTimeout(this.showErrTime),n&&l?(t.forEach(function(i){var l=i.field;l&&u.push(r.validItemRules(e||"all",l).then(function(){i.errRule=null}).catch(function(e){var t=e.rule,e={rule:t,rules:e.rules,data:n,field:l,property:l,$form:r};return s[l]||(s[l]=[]),s[l].push(e),a.push(l),i.errRule=t,Promise.reject(e)}))}),Promise.all(u).then(function(){i&&i()}).catch(function(){return new Promise(function(e){r.showErrTime=setTimeout(function(){t.forEach(function(e){e.errRule&&(e.showError=!0)})},20),o.autoPos&&r.$nextTick(function(){r.handleFocus(a)}),i?(i(s),e()):e(s)})})):(i&&i(),Promise.resolve())},validItemRules:function(n,o,e){var s,a,u=this,c=this.data,t=this.rules,f=[],d=[];return o&&t&&((s=_xeUtils.default.get(t,o))&&(a=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(c,o):e,s.forEach(function(t){var e,i=t.type,l=t.trigger,r=t.required;"all"!==n&&l&&n!==t.trigger||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({itemValue:a,rule:t,rules:s,data:c,field:o,property:o,$form:u}))&&(_xeUtils.default.isError(e)?f.push(new Rule({type:"custom",trigger:l,content:e.message,rule:new Rule(t)})):e.catch&&d.push(e.catch(function(e){f.push(new Rule({type:"custom",trigger:l,content:e?e.message:t.content||t.message,rule:new Rule(t)}))}))):(i="array"===i?!_xeUtils.default.isArray(a)||!a.length:(0,_utils.eqEmptyValue)(a),(r?i||validErrorRuleValue(t,a):!i&&validErrorRuleValue(t,a))&&f.push(new Rule(t))))}))),Promise.all(d).then(function(){if(f.length){var e={rules:f,rule:f[0]};return Promise.reject(e)}})},handleFocus:function(e){var n=this,o=this.$el;e.some(function(e,t){var i=n.getItemByField(e);if(i&&(0,_utils.isEnableConf)(i.itemRender)){var l,r=i.itemRender,e=_vXETable.default.renderer.get(r.name);if(t||_dom.default.scrollToView(o.querySelector(".".concat(i.id))),l=!(l=r.autofocus?o.querySelector(".".concat(i.id," ").concat(r.autofocus)):l)&&e&&e.autofocus?o.querySelector(".".concat(i.id," ").concat(e.autofocus)):l)return l.focus(),_dom.browse.msie&&((l=l.createTextRange()).collapse(!1),l.select()),!0}})},updateStatus:function(e,t){var i=this,l=e.property;l&&this.validItemRules("change",l,t).then(function(){i.clearValidate(l)}).catch(function(e){var t=e.rule,e=i.getItemByField(l);e&&(e.showError=!0,e.errRule=t)})}}};exports.default=_default2;